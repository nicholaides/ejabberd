#!/usr/bin/env escript
%%! -name addToCluster@<%= @node[:fqdn] %> -setcookie <%= node[:ejabberd_erlang_cookie] %>

main([HostFQDN]) ->
  Node = 'ejabberd@<%= @node[:fqdn] %>',
  Host = list_to_atom(string:concat("ejabberd@",HostFQDN)),
  rpc:call(Node, application, stop,                   [ejabberd]                  ),
  rpc:call(Node, mnesia,      stop,                   []                          ),
  rpc:call(Node, mnesia,      delete_schema,          [[Node]]                    ),
  rpc:call(Node, mnesia,      start,                  []                          ),
  rpc:call(Node, mnesia,      change_config,          [extra_db_nodes, [Host]]    ),
  rpc:call(Node, mnesia,      change_table_copy_type, [schema, Node, disc_copies] ),
  rpc:call(Node, mnesia,      info,                   []                          ),
  rpc:call(Node, application, start,                  [ejabberd]                  ).
